import{_ as o,c as a,a as d,o as c}from"./app-C7T5jqfQ.js";const n={};function r(t,e){return c(),a("div",null,e[0]||(e[0]=[d('<p>Cowboy 将请求处理委托给中间件组件。默认情况下，定义了两个中间件，用于路由和处理请求，这在本指南的大部分内容中都有详细介绍。</p><p>中间件使您能够完全控制请求的处理方式。您可以添加自己的中间件或将中间件链完全更改以满足需求。</p><p>Cowboy 将按照给定的顺序执行所有中间件，除非其中一个中间件决定停止处理。</p><h2 id="使用" tabindex="-1"><a class="header-anchor" href="#使用"><span>使用</span></a></h2><p>中间件只需要实现一个回调函数：<code>execute/2</code>。该回调函数定义在 <code>cowboy_middleware</code> 行为中。</p><p>该回调函数有两个参数。第一个是 <code>Req</code> 对象。第二个是环境。</p><p>中间件可以返回三种不同的值：</p><ul><li><code>{ok, Req, Env}</code> 继续请求处理</li><li><code>{suspend, Module, Function, Args}</code> 休眠</li><li><code>{stop, Req}</code> 停止处理并转到下一个请求</li></ul><p>休眠时，处理将在给定的 MFA 上恢复，丢弃所有之前的堆栈跟踪。请确保在 MFA 的参数中保留 <code>Req</code> 和 <code>Env</code> 以供以后使用。</p><p>如果在中间件处理过程中发生错误，Cowboy 将不会尝试将错误发送回套接字，进程将会崩溃。中间件需要确保在出现问题时发送回复。</p><h2 id="配置" tabindex="-1"><a class="header-anchor" href="#配置"><span>配置</span></a></h2><p>中间件环境定义为 <code>env</code> 协议选项。在前面的章节中，我们在需要传递路由信息时简要地见过它。它是一个元组列表，第一个元素是原子，第二个元素是任何 Erlang 表达式。</p><p>环境中有两个值是保留的：</p><ul><li><code>listener</code> 包含监听器的名称</li><li><code>result</code> 包含处理的结果</li></ul><p><code>listener</code> 值总是被定义的。<code>result</code> 值可以由任何中间件设置。如果设置为 <code>ok</code> 以外的任何值，Cowboy 将不会处理此连接上的任何后续请求。</p><p>Cowboy 附带的中间件可能会定义或需要其他环境值来执行。</p><p>你可以通过调用 <code>cowboy:set_env/3</code> 方便函数来更新环境，添加或替换环境中的一个值。</p><h2 id="路由中间件" tabindex="-1"><a class="header-anchor" href="#路由中间件"><span>路由中间件</span></a></h2><p>路由中间件需要 <code>dispatch</code> 值。如果路由成功，它会将处理程序名称和选项放入环境的 <code>handler</code> 和 <code>handler_opts</code> 值中。</p><h2 id="处理程序中间件" tabindex="-1"><a class="header-anchor" href="#处理程序中间件"><span>处理程序中间件</span></a></h2><p>处理程序中间件需要 <code>handler</code> 和 <code>handler_opts</code> 值。它会将请求处理的结果放入 <code>result</code> 中。</p>',21)]))}const s=o(n,[["render",r]]),l=JSON.parse('{"path":"/backend/erlang/9j8mo3xu/","title":"中间件","lang":"zh-CN","frontmatter":{"title":"中间件","createTime":"2025/03/28 11:47:56","permalink":"/backend/erlang/9j8mo3xu/"},"headers":[],"readingTime":{"minutes":2.02,"words":606},"git":{"updatedTime":1743158971000,"contributors":[{"name":"syh","username":"syh","email":"syh@qq.com","commits":1,"avatar":"https://gravatar.com/avatar/060d67e779a1b0aeace68a2a010b367f852e56888393383ea27302df983f6814?d=retro"}]},"filePathRelative":"notes/backend/erlang/rebar3/cowboy/advanced/middlewares.md"}');export{s as comp,l as data};
